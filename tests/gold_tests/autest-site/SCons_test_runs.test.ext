
def filter_path_chars(s):
    try:
        # python 3 case
        tb = str.maketrans({k: '' for k in r'\/:*?"<>|'})
        return s.translate(tb)
    except:
        # python2 case to go away
        return s.translate(None, r'\/:*?"<>|')


def AddCleanRun(Test, target='all', options=''):
    tr = Test.AddTestRun(
        "Cleaning Target: {0}".format(filter_path_chars(target)),
        "cleaning_target"
    )
    tr.Command = 'scons -c {0} {1} --console-stream=none'.format(target, options)
    tr.ReturnCode = 0
    return tr


def AddUpdateCheckSCons(Test, target='all', options=''):
    tr = Test.AddTestRun(
        "Check SCons is up-to-date for target -> {}".format(target),
        "scons-update-check-{}".format(filter_path_chars(target)),
    )
    tr.Command = 'scons -q {0} {1} --disable-parts-cache --console-stream=none'.format(target, options)
    tr.ReturnCode = 0
    return tr


def AddUpdateCheckParts(Test, target='all', options=''):
    tr = Test.AddTestRun(
        "Check Parts is up-to-date for target -> {}".format(target),
        "parts-update-check-{}".format(filter_path_chars(target)),
    )
    tr.Command = 'scons -q {0} {1} --console-stream=none'.format(target, options)
    tr.ReturnCode = 0

    return tr


def AddUpdateCheck(Test, target='all', options=''):
    Test.AddUpdateCheckSCons(target, options)
    Test.AddUpdateCheckParts(target, options)


def AddOutOfDateCheckParts(Test, target="all", options=''):
    tr = Test.AddTestRun(
        "Check Parts is out-of-date for target -> {}".format(target),
        "parts-outdated-check-{}".format(filter_path_chars(target)),
    )
    tr.Command = 'scons -q {0} {1} --console-stream=none'.format(target, options)
    tr.ReturnCode = 1

    return tr


def AddOutOfDateCheckSCons(Test, target="all", options=''):
    tr = Test.AddTestRun(
        "Check SCons is out-of-date for target -> {}".format(target),
        "scons-outdated-check-{}".format(filter_path_chars(target)),
    )
    tr.Command = 'scons -q {0} {1} --disable-parts-cache --console-stream=none'.format(target, options)
    tr.ReturnCode = 1

    return tr

# todo set to not allow warnings unless we know they should happen
def AddBuildRun(Test, target="all", options='',allow_warnings=True, extra="" ): 

    if options:
        s = "Building target-> {0} options-> {1}".format(target, options)
    else:
        s = "Building target-> {0}".format(target)
    tr = Test.AddTestRun(
        s, f"build-{filter_path_chars(target)}{extra}"
    )
    tr.Command = 'scons {0} {1} --console-stream=none'.format(target, options)
    tr.ReturnCode = 0
    if not allow_warnings:
        tr.Processes.Default.Streams.Warning.Content = Testers.ExcludesExpression("Parts: Warning!:","Warnings should not exists")

    return tr


def AddOutOfDateCheck(Test, target='all', options=''):
    Test.AddOutOfDateCheckSCons(target, options)
    Test.AddOutOfDateCheckParts(target, options)


AddTestRunSet(AddCleanRun)
AddTestRunSet(AddUpdateCheckSCons)
AddTestRunSet(AddUpdateCheckParts)
AddTestRunSet(AddUpdateCheck)
AddTestRunSet(AddOutOfDateCheckParts)
AddTestRunSet(AddOutOfDateCheckSCons)
AddTestRunSet(AddBuildRun)
AddTestRunSet(AddOutOfDateCheck)
